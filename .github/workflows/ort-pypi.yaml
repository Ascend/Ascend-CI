name: Build and publish to PyPI

on:
  workflow_dispatch:
  schedule:
    - cron: '0 12 * * *'

jobs:
  build-x86:
    name: Build for x86_64
    runs-on: ONNXRuntime
    steps:
      - name: Clone ASCEND-CI project
        uses: actions/checkout@v4
        with:
          repository: Ascend/Ascend-CI
          path: Ascend-CI

      - name: Build and upload pypi
        env:
          PYPI_TOKEN: ${{ secrets.PYPI_TOKEN }}
        working-directory: Ascend-CI
        run: |
          docker run --rm \
            -v ${{ github.workspace }}/Ascend-CI:/root/Ascend-CI \
            -v /root/.last_tag:/root/.last_tag \
            -e PYPI_TOKEN \
            pypi:latest \
            bash -c "chmod +x /root/Ascend-CI/script/pypiPkg.sh && /root/Ascend-CI/script/pypiPkg.sh"
          
  build-aarch:
      name: Build for aarch
      runs-on: pypi-aarch
      steps:
        - name: Clone ASCEND-CI project
          uses: actions/checkout@v4
          with:
            repository: Ascend/Ascend-CI
            path: Ascend-CI

        - name: Build and upload pypi
          env:
            PYPI_TOKEN: ${{ secrets.PYPI_TOKEN }}
          working-directory: Ascend-CI
          run: |
            docker run --rm \
              -v ${{ github.workspace }}/Ascend-CI:/root/Ascend-CI \
              -v /root/.last_tag:/root/.last_tag \
              -e PYPI_TOKEN \
              pypi:latest \
              bash -c "chmod +x /root/Ascend-CI/script/pypiPkg.sh && /root/Ascend-CI/script/pypiPkg.sh"
          
